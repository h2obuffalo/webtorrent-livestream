<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>P2P HLS Debug - Enhanced Logging</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0b0f14;
      color: #e6eef7;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      margin-bottom: 10px;
      font-size: 2rem;
      background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .subtitle {
      text-align: center;
      color: #888;
      margin-bottom: 30px;
    }

    .status-bar {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    .status-item {
      padding: 10px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 6px;
    }

    .status-label {
      color: #888;
      font-size: 0.8rem;
      margin-bottom: 5px;
    }

    .status-value {
      color: #4ecdc4;
      font-size: 1.1rem;
      font-weight: 600;
    }

    .test-section {
      background: #101826;
      border: 1px solid #223040;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    button {
      background: #4ecdc4;
      color: #000;
      border: none;
      padding: 12px 24px;
      font-size: 1.1rem;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      margin: 10px 10px 10px 0;
      transition: transform 0.1s;
    }

    button:hover {
      transform: scale(1.05);
    }

    button:active {
      transform: scale(0.95);
    }

    .video-container {
      position: relative;
      background: #000;
      border-radius: 8px;
      overflow: hidden;
      margin: 15px 0;
      aspect-ratio: 16/9;
    }

    video {
      width: 100%;
      height: 100%;
      display: block;
      object-fit: contain;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin: 15px 0;
    }

    .stat-box {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid #223040;
      border-radius: 6px;
      padding: 10px;
      text-align: center;
    }

    .stat-label {
      color: #888;
      font-size: 0.8rem;
      margin-bottom: 5px;
    }

    .stat-value {
      color: #4ecdc4;
      font-size: 1.4rem;
      font-weight: 600;
    }

    .log {
      background: #000;
      border: 1px solid #223040;
      border-radius: 6px;
      padding: 15px;
      height: 400px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 0.85rem;
      margin-top: 15px;
    }

    .log-entry {
      padding: 2px 0;
      border-bottom: 1px solid #111;
    }

    .log-time { color: #666; margin-right: 10px; }
    .log-info { color: #4ecdc4; }
    .log-warn { color: #ffa600; }
    .log-error { color: #ff6b6b; }
    .log-success { color: #4ade80; }
    .log-debug { color: #a78bfa; }

    .input-group {
      margin: 15px 0;
    }

    label {
      display: block;
      margin-bottom: 5px;
      color: #aaa;
      font-size: 0.9rem;
    }

    input[type="text"] {
      width: 100%;
      padding: 10px;
      background: #0b0f14;
      border: 2px solid #223040;
      border-radius: 6px;
      color: #fff;
      font-size: 1rem;
      font-family: monospace;
    }

    .preset-btn {
      background: #223040;
      color: #fff;
      padding: 8px 16px;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🔍 P2P HLS Debug - Enhanced Tracker Diagnostics</h1>
    <p class="subtitle">Deep inspection of p2p-media-loader initialization and tracker communication</p>

    <!-- Status Bar -->
    <div class="status-bar">
      <div class="status-item">
        <div class="status-label">P2P Engine</div>
        <div class="status-value" id="engine-status">Not Started</div>
      </div>
      <div class="status-item">
        <div class="status-label">Peers Connected</div>
        <div class="status-value" id="peer-count">0</div>
      </div>
      <div class="status-item">
        <div class="status-label">Tracker Status</div>
        <div class="status-value" id="tracker-status">Idle</div>
      </div>
      <div class="status-item">
        <div class="status-label">Segments Loaded</div>
        <div class="status-value" id="segment-count">0</div>
      </div>
      <div class="status-item">
        <div class="status-label">P2P Downloaded</div>
        <div class="status-value" id="p2p-downloaded">0 MB</div>
      </div>
      <div class="status-item">
        <div class="status-label">HTTP Downloaded</div>
        <div class="status-value" id="http-downloaded">0 MB</div>
      </div>
    </div>

    <!-- Test Section -->
    <div class="test-section">
      <h2>📺 P2P HLS Stream Test</h2>
      
      <div class="input-group">
        <label for="hls-url">HLS Stream URL (.m3u8):</label>
        <input type="text" id="hls-url" value="https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8" placeholder="https://example.com/stream.m3u8">
      </div>

      <div style="display: flex; flex-wrap: wrap; gap: 10px; margin: 10px 0;">
        <button class="preset-btn" onclick="setPreset('mux')">Mux Test Stream</button>
        <button class="preset-btn" onclick="setPreset('big-buck')">Big Buck Bunny</button>
      </div>

      <button onclick="playStream()">▶️ Play with P2P</button>
      <button onclick="stopStream()">⏹️ Stop</button>
      <button onclick="clearLog()">🗑️ Clear Log</button>

      <div class="video-container">
        <video id="video" controls playsinline></video>
      </div>

      <div class="stats-grid">
        <div class="stat-box">
          <div class="stat-label">P2P Ratio</div>
          <div class="stat-value" id="p2p-ratio">0%</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Buffer</div>
          <div class="stat-value" id="buffer">0s</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Current Time</div>
          <div class="stat-value" id="current-time">0s</div>
        </div>
      </div>

      <div class="log" id="log"></div>
    </div>

  </div>

  <!-- HLS.js (v1.0.7 - compatible with p2p-media-loader 0.6.2) -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.0.7/dist/hls.min.js"></script>
  
  <!-- P2P Media Loader v0.6 (browser build - stable) -->
  <script src="https://cdn.jsdelivr.net/npm/p2p-media-loader-core@0.6.2/build/p2p-media-loader-core.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/p2p-media-loader-hlsjs@0.6.2/build/p2p-media-loader-hlsjs.min.js"></script>

  <script>
    // State
    let hls = null;
    let p2pEngine = null;
    let statsInterval = null;
    let segmentCount = 0;
    
    const stats = {
      p2pDownloaded: 0,
      httpDownloaded: 0,
      peers: 0
    };

    // Enhanced Logging
    function log(message, type = 'info') {
      const now = new Date();
      const time = now.toLocaleTimeString() + '.' + now.getMilliseconds().toString().padStart(3, '0');
      
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.innerHTML = `<span class="log-time">${time}</span><span>${message}</span>`;
      
      const logPanel = document.getElementById('log');
      logPanel.appendChild(entry);
      logPanel.scrollTop = logPanel.scrollHeight;
      
      while (logPanel.children.length > 100) {
        logPanel.removeChild(logPanel.firstChild);
      }
      
      console.log(`[${type.toUpperCase()}] ${time}`, message);
    }

    function clearLog() {
      document.getElementById('log').innerHTML = '';
      log('🗑️ Log cleared', 'info');
    }

    // Presets
    function setPreset(preset) {
      const presets = {
        'mux': 'https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8',
        'big-buck': 'https://test-streams.mux.dev/x36xhzz/url_6/193039199_mp4_h264_aac_hq_7.m3u8',
      };
      if (presets[preset]) {
        document.getElementById('hls-url').value = presets[preset];
      }
    }

    // Play Stream
    function playStream() {
      const url = document.getElementById('hls-url').value.trim();
      
      if (!url) {
        log('❌ Please enter an HLS URL', 'error');
        return;
      }

      if (!Hls.isSupported()) {
        log('❌ HLS.js not supported on this browser', 'error');
        return;
      }

      log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━', 'info');
      log('🎬 Starting P2P HLS playback...', 'info');
      log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━', 'info');
      
      const video = document.getElementById('video');

      // Detailed library checks
      log('🔍 Step 1: Checking P2P Media Loader availability...', 'debug');
      log(`  ├─ window.p2pml = ${typeof window.p2pml}`, 'debug');
      log(`  ├─ window.p2pml.hlsjs = ${typeof window.p2pml?.hlsjs}`, 'debug');
      log(`  ├─ window.p2pml.hlsjs.Engine = ${typeof window.p2pml?.hlsjs?.Engine}`, 'debug');
      log(`  └─ window.p2pml.core = ${typeof window.p2pml?.core}`, 'debug');
      
      if (typeof window.p2pml === 'undefined' || !window.p2pml.hlsjs || !window.p2pml.hlsjs.Engine) {
        log('❌ P2P Media Loader not available!', 'error');
        log('⚠️  This usually means the CDN failed to load the library', 'warn');
        log('💡 Try hard refresh (Ctrl+Shift+R or Cmd+Shift+R)', 'warn');
        document.getElementById('engine-status').textContent = 'Failed';
        document.getElementById('engine-status').style.color = '#ff6b6b';
        return;
      }

      log('✅ P2P Media Loader libraries loaded successfully', 'success');

      try {
        log('🔍 Step 2: Creating P2P Engine configuration...', 'debug');
        
        // Enhanced P2P configuration with more trackers and debugging
        const p2pConfig = {
          segments: {
            forwardSegmentCount: 50,
          },
          loader: {
            trackerAnnounce: [
              'wss://tracker.openwebtorrent.com',
              'wss://tracker.webtorrent.dev',
              'wss://tracker.fastcast.nz',
              'wss://tracker.btorrent.xyz'
            ],
            rtcConfig: {
              iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:global.stun.twilio.com:3478' },
                { urls: 'stun:stun.services.mozilla.com:3478' }
              ]
            }
          }
        };
        
        log(`  ├─ Trackers: ${p2pConfig.loader.trackerAnnounce.length}`, 'debug');
        p2pConfig.loader.trackerAnnounce.forEach((t, i) => {
          log(`  │  ${i + 1}. ${t}`, 'debug');
        });
        log(`  └─ STUN servers: ${p2pConfig.loader.rtcConfig.iceServers.length}`, 'debug');
        
        log('🔍 Step 3: Initializing P2P Engine...', 'debug');
        
        // Create P2P engine
        p2pEngine = new window.p2pml.hlsjs.Engine(p2pConfig);
        
        log('✅ P2P Engine created successfully!', 'success');
        document.getElementById('engine-status').textContent = 'Initializing';
        document.getElementById('engine-status').style.color = '#ffa600';
        
        log('🔍 Step 4: Attaching event listeners...', 'debug');
        
        // CRITICAL: Wire up ALL event listeners with maximum verbosity
        
        // Peer events
        p2pEngine.on('peer_connect', (peer) => {
          stats.peers++;
          log(`🤝 PEER CONNECTED! ID: ${peer?.id || 'unknown'}`, 'success');
          log(`   └─ Total peers: ${stats.peers}`, 'success');
          document.getElementById('peer-count').textContent = stats.peers;
          updateStats();
        });
        
        p2pEngine.on('peer_close', (peerId) => {
          stats.peers = Math.max(0, stats.peers - 1);
          log(`👋 Peer disconnected: ${peerId}`, 'warn');
          log(`   └─ Remaining peers: ${stats.peers}`, 'warn');
          document.getElementById('peer-count').textContent = stats.peers;
          updateStats();
        });
        
        // Segment events
        p2pEngine.on('segment_loaded', (segment, peerId) => {
          segmentCount++;
          const size = segment.data?.byteLength || segment.size || 0;
          
          if (peerId) {
            stats.p2pDownloaded += size;
            log(`📥 P2P: Segment ${segmentCount} from peer ${peerId} (${(size / 1024).toFixed(2)} KB)`, 'success');
          } else {
            stats.httpDownloaded += size;
            log(`📡 HTTP: Segment ${segmentCount} (${(size / 1024).toFixed(2)} KB)`, 'info');
          }
          
          document.getElementById('segment-count').textContent = segmentCount;
          updateStats();
        });
        
        p2pEngine.on('peer_data_sent', (data) => {
          log(`📤 UPLOADED data to peer (${data?.bytes || 'unknown'} bytes)`, 'success');
        });
        
        // TRACKER EVENTS - This is what we're looking for!
        p2pEngine.on('tracker_announce', (data) => {
          log(`━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━`, 'success');
          log(`📢 TRACKER ANNOUNCE! Announcing to tracker swarm`, 'success');
          log(`   ├─ URL: ${data?.url || data?.tracker || 'unknown'}`, 'success');
          log(`   ├─ InfoHash: ${data?.infoHash?.substr(0, 20) || 'unknown'}...`, 'success');
          log(`   └─ Status: ANNOUNCING TO SWARM`, 'success');
          log(`━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━`, 'success');
          document.getElementById('tracker-status').textContent = 'Announcing';
          document.getElementById('tracker-status').style.color = '#4ade80';
        });
        
        p2pEngine.on('tracker_update', (data) => {
          const peerCount = data?.peers?.length || 0;
          log(`━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━`, 'success');
          log(`📊 TRACKER UPDATE! Received peer list from tracker`, 'success');
          log(`   ├─ Available peers in swarm: ${peerCount}`, 'success');
          if (peerCount > 0 && data?.peers) {
            log(`   ├─ Peer IDs:`, 'success');
            data.peers.slice(0, 5).forEach((p, i) => {
              log(`   │  ${i + 1}. ${p?.id || p}`, 'success');
            });
            if (peerCount > 5) log(`   │  ... and ${peerCount - 5} more`, 'success');
          }
          log(`   └─ Will attempt to connect to available peers`, 'success');
          log(`━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━`, 'success');
          document.getElementById('tracker-status').textContent = `${peerCount} in swarm`;
        });
        
        p2pEngine.on('tracker_error', (error) => {
          log(`━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━`, 'error');
          log(`❌ TRACKER ERROR!`, 'error');
          log(`   ├─ Message: ${error?.message || error?.error || 'unknown'}`, 'error');
          log(`   ├─ Tracker: ${error?.tracker || error?.url || 'unknown'}`, 'error');
          log(`   └─ This tracker may be down or blocked`, 'error');
          log(`━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━`, 'error');
          document.getElementById('tracker-status').textContent = 'Error';
          document.getElementById('tracker-status').style.color = '#ff6b6b';
        });
        
        p2pEngine.on('tracker_warning', (warning) => {
          log(`⚠️ TRACKER WARNING: ${warning?.message || JSON.stringify(warning)}`, 'warn');
        });
        
        // Error events
        p2pEngine.on('peer_error', (error) => {
          log(`❌ PEER ERROR: ${error?.message || JSON.stringify(error)}`, 'error');
        });
        
        p2pEngine.on('segment_error', (error) => {
          log(`❌ SEGMENT ERROR: ${error?.message || JSON.stringify(error)}`, 'error');
        });
        
        log('✅ All event listeners attached', 'success');
        
        // Get engine details
        setTimeout(() => {
          try {
            const details = p2pEngine.getDetails ? p2pEngine.getDetails() : {};
            log(`🔍 Engine Details:`, 'debug');
            log(`   ├─ Peer ID: ${details?.peerId || 'unknown'}`, 'debug');
            log(`   ├─ Version: ${details?.version || 'unknown'}`, 'debug');
            log(`   └─ Ready: ${details?.ready || 'unknown'}`, 'debug');
          } catch(e) {
            log(`⚠️ Cannot get engine details: ${e.message}`, 'warn');
          }
        }, 2000);
        
        log('🔍 Step 5: Creating HLS instance with P2P loader...', 'debug');
        
        // Create HLS with P2P loader
        const hlsConfig = p2pEngine.createLoaderClass();
        
        hls = new Hls({
          ...hlsConfig,
          liveSyncDuration: 3,
          liveMaxLatencyDuration: 10,
          backBufferLength: 30,
          maxBufferLength: 30,
          lowLatencyMode: true,
          debug: false
        });
        
        log('✅ HLS instance created with P2P loader', 'success');
        
        // HLS event listeners
        hls.on(Hls.Events.MANIFEST_PARSED, (event, data) => {
          log(`✅ HLS: Manifest parsed`, 'success');
          log(`   ├─ Levels: ${data.levels.length}`, 'debug');
          log(`   └─ Starting playback...`, 'debug');
          video.play().catch(err => {
            log(`⚠️ Autoplay blocked: ${err.message}. Click video to play.`, 'warn');
          });
        });
        
        hls.on(Hls.Events.LEVEL_LOADED, (event, data) => {
          log(`📋 HLS: Level loaded (${data.details.fragments.length} fragments)`, 'debug');
        });
        
        hls.on(Hls.Events.FRAG_LOADING, (event, data) => {
          log(`🔄 HLS: Loading fragment ${data.frag.sn} - ${data.frag.url.split('/').pop()}`, 'info');
        });
        
        hls.on(Hls.Events.FRAG_LOADED, (event, data) => {
          const size = data.stats?.total || data.frag?.stats?.total || 0;
          const loadTime = data.stats?.loading ? (data.stats.loading.end - data.stats.loading.start) : 0;
          log(`✅ HLS: Fragment ${data.frag.sn} loaded (${(size / 1024).toFixed(2)} KB${loadTime > 0 ? ` in ${loadTime}ms` : ''})`, 'success');
        });

        hls.on(Hls.Events.ERROR, (event, data) => {
          if (data.fatal) {
            log(`❌ Fatal HLS error: ${data.type} - ${data.details}`, 'error');
            
            switch(data.type) {
              case Hls.ErrorTypes.NETWORK_ERROR:
                log('⚠️  Attempting to recover from network error...', 'warn');
                hls.startLoad();
                break;
              case Hls.ErrorTypes.MEDIA_ERROR:
                log('⚠️  Attempting to recover from media error...', 'warn');
                hls.recoverMediaError();
                break;
              default:
                log('❌ Cannot recover, stopping playback', 'error');
                stopStream();
                break;
            }
          } else {
            log(`⚠️ HLS warning: ${data.details}`, 'warn');
          }
        });

        log('🔍 Step 6: Loading source and attaching media...', 'debug');
        
        // Load and play
        hls.loadSource(url);
        hls.attachMedia(video);
        
        log(`✅ Source loaded: ${url.substring(0, 60)}...`, 'success');
        log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━', 'info');
        log('⏳ Waiting for fragments to load...', 'info');
        log('💡 Watch for "📢 TRACKER ANNOUNCE" messages above!', 'info');
        log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━', 'info');
        
        document.getElementById('engine-status').textContent = 'Active';
        document.getElementById('engine-status').style.color = '#4ade80';

        // Start stats updates
        statsInterval = setInterval(updateStats, 1000);

      } catch (err) {
        log(`❌ Error initializing P2P: ${err.message}`, 'error');
        log(`   Stack: ${err.stack}`, 'error');
        document.getElementById('engine-status').textContent = 'Error';
        document.getElementById('engine-status').style.color = '#ff6b6b';
      }
    }

    // Stop Stream
    function stopStream() {
      if (hls) {
        hls.destroy();
        hls = null;
      }
      
      if (p2pEngine) {
        p2pEngine.destroy();
        p2pEngine = null;
      }
      
      if (statsInterval) {
        clearInterval(statsInterval);
        statsInterval = null;
      }
      
      const video = document.getElementById('video');
      video.pause();
      video.src = '';
      
      stats.p2pDownloaded = 0;
      stats.httpDownloaded = 0;
      stats.peers = 0;
      segmentCount = 0;
      
      document.getElementById('engine-status').textContent = 'Stopped';
      document.getElementById('engine-status').style.color = '#888';
      document.getElementById('tracker-status').textContent = 'Idle';
      document.getElementById('tracker-status').style.color = '#888';
      
      updateStats();
      
      log('⏹️ Stream stopped', 'info');
    }

    // Update Stats
    function updateStats() {
      document.getElementById('peer-count').textContent = stats.peers;
      document.getElementById('p2p-downloaded').textContent = (stats.p2pDownloaded / 1024 / 1024).toFixed(2) + ' MB';
      document.getElementById('http-downloaded').textContent = (stats.httpDownloaded / 1024 / 1024).toFixed(2) + ' MB';
      
      const total = stats.p2pDownloaded + stats.httpDownloaded;
      const p2pRatio = total > 0 ? (stats.p2pDownloaded / total * 100) : 0;
      document.getElementById('p2p-ratio').textContent = p2pRatio.toFixed(0) + '%';
      
      const video = document.getElementById('video');
      if (video.buffered.length > 0) {
        const buffered = video.buffered.end(0) - video.currentTime;
        document.getElementById('buffer').textContent = buffered.toFixed(1) + 's';
      }
      
      document.getElementById('current-time').textContent = video.currentTime.toFixed(1) + 's';
      document.getElementById('segment-count').textContent = segmentCount;
    }

    // Initialize
    window.addEventListener('DOMContentLoaded', () => {
      log('🚀 P2P HLS Debug Tester Ready!', 'info');
      log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━', 'info');
      log('📚 Libraries checking...', 'info');
      
      setTimeout(() => {
        if (typeof Hls === 'undefined') {
          log('❌ HLS.js failed to load', 'error');
        } else {
          log('✅ HLS.js v' + Hls.version + ' loaded', 'success');
        }
        
        if (typeof window.p2pml === 'undefined') {
          log('❌ P2P Media Loader failed to load', 'error');
        } else {
          log('✅ P2P Media Loader loaded', 'success');
        }
        
        log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━', 'info');
        log('💡 Open this page in 2-3 tabs simultaneously for P2P to work!', 'info');
        log('💡 All tabs must play the SAME stream URL', 'info');
        log('💡 Look for "📢 TRACKER ANNOUNCE" messages in the log', 'info');
        log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━', 'info');
      }, 1000);
    });
  </script>
</body>
</html>

